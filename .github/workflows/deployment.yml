name: ðŸš€ Deployment

on:
  push:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  REPO: ${{ github.repository }}
  GITHUB_TOKEN: ${{ github.token }}
  DEPLOYMENT_ENV: ${{ github.ref_name == 'main' && github.actor != 'dependabot[bot]' && 'Production' || 'Preview' }}

jobs:
  deploy-worker:
    name: Deploy to Cloudflare Workers
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      result: ${{ steps.deploy.outcome }}
      url: ${{ steps.deployment-url.outputs.result }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Build
        run: pnpm build

      - name: Deploy
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          packageManager: pnpm
          command: ${{ env.DEPLOYMENT_ENV == 'Production' && 'deploy' || 'versions upload' }}
        continue-on-error: true

      - name: Get deployment url
        id: deployment-url
        if: steps.deploy.outcome == 'success'
        env:
          RAW_URL: ${{ steps.deploy.outputs.deployment-url }}
        run: |
          RAW_URL="${RAW_URL:-}"
          workerUrl=""

          if [ -n "$RAW_URL" ]; then
            cleanDomain=$(echo "$RAW_URL" | sed 's/([^)]*)//g' | awk -F'[,;[:space:]]+' '{print $1}' | xargs)
            if [ -n "$cleanDomain" ]; then
              [[ ! "$cleanDomain" =~ ^https?:// ]] && workerUrl="https://$cleanDomain" || workerUrl="$cleanDomain"
            fi
          fi

          echo "result=$workerUrl" >> "$GITHUB_OUTPUT"
          echo "$workerUrl"

  extract-metadata:
    name: Extract Metadata
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: read
    outputs:
      worker-name: ${{ steps.worker-name.outputs.result }}
      pr: ${{ steps.pr.outputs.result }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          sparse-checkout: wrangler.jsonc
          sparse-checkout-cone-mode: false

      - name: Get worker name
        id: worker-name
        run: |
          NAME=$(sed '/\/\*/,/\*\//d; s/^\s*\/\/.*$//g' wrangler.jsonc | jq -r '.name // empty')
          echo "result=$NAME" >> $GITHUB_OUTPUT

      - name: Check a latest pull request
        id: pr
        env:
          COMMIT_SHA: ${{ github.sha }}
        run: |
          PR_INFO=$(gh pr list \
            --head "$COMMIT_SHA" \
            --state all \
            --limit 1 \
            --json number,title,url,mergeCommit,author \
            --jq '.[0] // {} | {
              commit: (.mergeCommit.oid // env.COMMIT_SHA) | .[0:7],
              number: .number,
              title: .title,
              url: .url,
              avatar_url: "https://github.com/\(.author.login).png"
            }')

          PR_NUMBER=$(echo "$PR_INFO" | jq -r '.number // empty')
          ([ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]) && PR_INFO=""

          echo "result=$PR_INFO" >> $GITHUB_OUTPUT

  deploy-github:
    name: Deploy to GitHub
    runs-on: ubuntu-latest
    needs: [deploy-worker]
    permissions:
      deployments: write
    steps:
      - name: Create deployment
        id: create-deployment
        env:
          REF: ${{ github.sha }}
        run: |
          DEPLOY_ID=$(gh api repos/$REPO/deployments \
            --method POST \
            --header "Accept: application/vnd.github+json" \
            --input - \
            -q '.id' <<EOF
            {
              "ref": "$REF",
              "environment": "$DEPLOYMENT_ENV",
              "auto_merge": false,
              "required_contexts": []
            }
            EOF
          )

          echo "deploy-id=$DEPLOY_ID" >> $GITHUB_OUTPUT

      - name: Conclude deployment
        env:
          DEPLOY_ID: ${{ steps.create-deployment.outputs.deploy-id }}
          CONCLUSION: ${{ needs.deploy-worker.outputs.result }}
          DEPLOYMENT_URL: ${{ needs.deploy-worker.outputs.url }}
        run: |
          gh api repos/$REPO/deployments/$DEPLOY_ID/statuses \
            -F state="$CONCLUSION" \
            -F environment=$DEPLOYMENT_ENV \
            -F environment_url=$DEPLOYMENT_URL

  comment-pr:
    name: Comment on Pull Request
    runs-on: ubuntu-latest
    needs: [deploy-worker, extract-metadata]
    if: needs.extract-metadata.outputs.pr != ''
    timeout-minutes: 5
    permissions:
      pull-requests: write
    steps:
      - env:
          DEPLOYED: ${{ needs.deploy-worker.outputs.result == 'success' }}
          DEPLOYMENT_URL: ${{ needs.deploy-worker.outputs.url }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CF_WORKER_NAME: ${{ needs.extract-metadata.outputs.worker-name }}
          PR_JSON: ${{ needs.extract-metadata.outputs.pr }}
          RUN_ID: ${{ github.run_id }}
        run: |
          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.number // empty')
          PR_COMMIT=$(echo "$PR_JSON" | jq -r '.commit // empty')
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.title // empty')
          PR_URL=$(echo "$PR_JSON" | jq -r '.url // empty')
          AVATAR_URL=$(echo "$PR_JSON" | jq -r '.avatar_url // empty')

          if [ -z "$PR_NUMBER" ]; then
            echo "No pull request found."
            exit 0
          fi

          STATUS_CELL=":x: Failed"
          [ "$DEPLOYED" = "true" ] && STATUS_CELL=":white_check_mark: Success"

          BODY="### âš¡ Deploying with Cloudflare Workers

          | **Status** | ${STATUS_CELL}! |
          | :--- | :--- |
          | **Environment** | ${DEPLOYMENT_ENV} |"

          [ -n "$PR_COMMIT" ] && BODY="${BODY}
          | **Commit** | [\`${PR_COMMIT}\`](https://github.com/${REPO}/commit/${PR_COMMIT}) |"

          [ -n "$DEPLOYMENT_URL" ] && BODY="${BODY}
          | **URL** | ${DEPLOYMENT_URL} |"

          BODY="${BODY}
          | **Details** | :arrow_right: [GitHub Actions](https://github.com/${REPO}/actions/runs/${RUN_ID}) <br /> :arrow_right: [Cloudflare Dashboard](https://dash.cloudflare.com/${CF_ACCOUNT_ID}/workers/services/view/${CF_WORKER_NAME}/production/deployments) |"

          gh pr comment "$PR_NUMBER" --body "$BODY"

  notify-slack:
    name: Notify to Slack
    runs-on: ubuntu-latest
    needs: [deploy-worker, extract-metadata]
    if: needs.extract-metadata.outputs.pr != ''
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          sparse-checkout: .github/actions/setup-slack-payload

      - name: Setup slack payload
        id: slack-payload
        uses: ./.github/actions/setup-slack-payload
        with:
          slack_channel_id: ${{ secrets.SLACK_CHANNEL_ID }}
          deployed: ${{ needs.deploy-worker.outputs.result == 'success' }}
          deployment_env: ${{ env.DEPLOYMENT_ENV }}
          deployment_url: ${{ needs.deploy-worker.outputs.url }}
          cloudflare_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          cloudflare_worker_name: ${{ needs.extract-metadata.outputs.worker-name }}
          pr_commit: ${{ fromJSON(needs.extract-metadata.outputs.pr).commit }}
          pr_number: ${{ fromJSON(needs.extract-metadata.outputs.pr).number }}
          pr_title: ${{ fromJSON(needs.extract-metadata.outputs.pr).title }}
          pr_url: ${{ fromJSON(needs.extract-metadata.outputs.pr).url }}
          avatar_url: ${{ fromJSON(needs.extract-metadata.outputs.pr).avatar_url }}

      - name: Send notification to Slack
        uses: slackapi/slack-github-action@v2
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload-file-path: ${{ steps.slack-payload.outputs.file-path }}
