name: ü§ñ Issue Template Processor
on:
  issues:
    types: [opened]

permissions:
  issues: write

env:
  GH_TOKEN: ${{ github.token }}
  ISSUE_NUMBER: ${{ github.event.issue.number }}
  ISSUE_TITLE: ${{ github.event.issue.title }}

jobs:
  initialize-processing:
    name: Initialize processing
    runs-on: ubuntu-latest
    outputs:
      comment-id: ${{ steps.comment.outputs.id }}
      category: ${{ steps.category.outputs.result }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check issue category
        id: category
        env:
          HAS_BUGFIX_LABEL: ${{ contains(github.event.issue.labels.*.name, 'BugFix') }}
          HAS_FEATURE_LABEL: ${{ contains(github.event.issue.labels.*.name, 'Feature') }}
        run: |
          CATEGORY="general"

          if [[ "$ISSUE_TITLE" == *"[Bug]"* ]] || [[ "$HAS_BUGFIX_LABEL" == "true" ]]; then
            CATEGORY="bug-report"
          elif [[ "$ISSUE_TITLE" == *"[Feature]"* ]] || [[ "$HAS_FEATURE_LABEL" == "true" ]]; then
            CATEGORY="feature-request"
          fi

          echo "result=$CATEGORY" >> $GITHUB_OUTPUT

      - name: Add initial comment
        id: comment
        run: |
          COMMENT_BODY="### üöÄ Processing started!"$'\n\n'"Refining the issue and assigning labels..."
          COMMENT_URL=$(gh issue comment $ISSUE_NUMBER --body "$COMMENT_BODY")
          COMMENT_ID=$(echo $COMMENT_URL | grep -oE "[0-9]+$")

          echo "id=$COMMENT_ID" >> $GITHUB_OUTPUT

  process-bug-report:
    name: Process bug-report issue
    needs: initialize-processing
    runs-on: ubuntu-latest
    if: contains(github.event.issue.title, '[Bug]') || contains(join(github.event.issue.labels.*.name), 'BugFix')
    env:
      TEMPLATE_PATH: .github/ISSUE_TEMPLATE/bug-report.yml
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Parse issue form
        uses: stefanbuck/github-issue-parser@v3
        id: issue-parser
        with:
          template-path: ${{ env.TEMPLATE_PATH }}

      - name: Render checklist
        uses: ./.github/actions/render-checklist
        id: checklist
        with:
          template-path: ${{ env.TEMPLATE_PATH }}
          checklist-input: ${{ steps.issue-parser.outputs.issueparser_checklist }}

      - name: Update issue content
        env:
          PROBLEM: ${{ steps.issue-parser.outputs.issueparser_problem }}
          REPRODUCTION: ${{ steps.issue-parser.outputs.issueparser_reproduction }}
          EXPECTED: ${{ steps.issue-parser.outputs.issueparser_expected }}
          REFERENCE: ${{ steps.issue-parser.outputs.issueparser_reference }}
          FREQUENCY: ${{ steps.issue-parser.outputs.issueparser_frequency }}
          SEVERITY: ${{ steps.issue-parser.outputs.issueparser_severity }}
          VERSION: ${{ steps.issue-parser.outputs.issueparser_version }}
          BROWSER: ${{ steps.issue-parser.outputs.issueparser_browser }}
          OS: ${{ steps.issue-parser.outputs.issueparser_os }}
          ADDITIONAL: ${{ steps.issue-parser.outputs.issueparser_additional }}
          CHECKLIST: ${{ steps.checklist.outputs.section }}
        run: |
          OPTIONAL_DETAILS="<br />"

          DEVICE_INFO=""
          [ -n "$VERSION" ] && [ "$VERSION" != "_No response_" ] && DEVICE_INFO="$DEVICE_INFO- Version: \`$VERSION\`"
          [ -n "$OS" ] && [ "$OS" != "_No response_" ] && DEVICE_INFO="$DEVICE_INFO"$'\n'"- OS: $OS"
          [ -n "$BROWSER" ] && [ "$BROWSER" != "_No response_" ] && DEVICE_INFO="$DEVICE_INFO"$'\n'"- Browser: $BROWSER"

          [ -n "$DEVICE_INFO" ] && OPTIONAL_DETAILS="$OPTIONAL_DETAILS"$'\n\n'"### ‚öôÔ∏è Device Information"$'\n\n'"$DEVICE_INFO"
          [ -n "$REFERENCE" ] && [ "$REFERENCE" != "_No response_" ] && OPTIONAL_DETAILS="$OPTIONAL_DETAILS"$'\n\n'"### üîó Reference"$'\n\n'"$REFERENCE"
          [ -n "$ADDITIONAL" ] && [ "$ADDITIONAL" != "_No response_" ] && OPTIONAL_DETAILS="$OPTIONAL_DETAILS"$'\n\n'"### ‚ûï Additional Information"$'\n\n'"$ADDITIONAL"

          NEW_BODY=$(cat <<EOF
          > **Severity:** $SEVERITY
          > **Frequency:** $FREQUENCY

          <br />

          ## ‚ùì Problem

          $PROBLEM

          <br />

          ## ‚Ü™Ô∏è Steps to Reproduce

          $REPRODUCTION

          <br />

          ## üéØ Expected Behavior

          $EXPECTED

          $OPTIONAL_DETAILS

          $CHECKLIST

          > ‚ö° Generated by **GitHub Actions**
          EOF
          )

          LABEL_NAME=$(echo "$SEVERITY" | sed 's/[^a-zA-Z ]//g' | awk '{print $1}')

          gh issue edit $ISSUE_NUMBER --body "$NEW_BODY" --add-label="$LABEL_NAME"

  process-feature-request:
    name: Process feature-request issue
    needs: initialize-processing
    runs-on: ubuntu-latest
    if: contains(github.event.issue.title, '[Feature]') || contains(join(github.event.issue.labels.*.name), 'Feature')
    env:
      TEMPLATE_PATH: .github/ISSUE_TEMPLATE/feature-request.yml
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Parse issue form
        uses: stefanbuck/github-issue-parser@v3
        id: issue-parser
        with:
          template-path: ${{ env.TEMPLATE_PATH }}

      - name: Render checklist
        uses: ./.github/actions/render-checklist
        id: checklist
        with:
          template-path: ${{ env.TEMPLATE_PATH }}
          checklist-input: ${{ steps.issue-parser.outputs.issueparser_checklist }}

      - name: Update issue content
        env:
          TYPE: ${{ steps.issue-parser.outputs.issueparser_type }}
          CONTEXT: ${{ steps.issue-parser.outputs.issueparser_context }}
          SOLUTION: ${{ steps.issue-parser.outputs.issueparser_solution }}
          ALTERNATIVE: ${{ steps.issue-parser.outputs.issueparser_alternative }}
          EXAMPLE: ${{ steps.issue-parser.outputs.issueparser_example }}
          PRIORITY: ${{ steps.issue-parser.outputs.issueparser_priority }}
          USER_GROUP: ${{ steps.issue-parser.outputs.issueparser_user_group }}
          COMPATIBILITY_IMPACT: ${{ steps.issue-parser.outputs.issueparser_compatibility_impact }}
          REFERENCE: ${{ steps.issue-parser.outputs.issueparser_reference }}
          ADDITIONAL: ${{ steps.issue-parser.outputs.issueparser_additional }}
          CHECKLIST: ${{ steps.checklist.outputs.section }}
        run: |
          METADATA_SECTION=""
          [ -n "$USER_GROUP" ] && [ "$USER_GROUP" != "_No response_" ] && METADATA_SECTION="$METADATA_SECTION> **Target**: $USER_GROUP"$'\n'
          [ -n "$COMPATIBILITY_IMPACT" ] && [ "$COMPATIBILITY_IMPACT" != "_No response_" ] && METADATA_SECTION="$METADATA_SECTION> **Compatibility Impact**: $COMPATIBILITY_IMPACT"$'\n'
          METADATA_SECTION="$METADATA_SECTION"$'\n'"<br />"

          OPTIONAL_DETAILS="<br />"
          [ -n "$ALTERNATIVE" ] && [ "$ALTERNATIVE" != "_No response_" ] && OPTIONAL_DETAILS="$OPTIONAL_DETAILS"$'\n\n'"### üîÑÔ∏è Alternative Considered"$'\n\n'"$ALTERNATIVE"
          [ -n "$EXAMPLE" ] && [ "$EXAMPLE" != "_No response_" ] && OPTIONAL_DETAILS="$OPTIONAL_DETAILS"$'\n\n'"### üß™ Usage Example"$'\n\n'"$EXAMPLE"
          [ -n "$REFERENCE" ] && [ "$REFERENCE" != "_No response_" ] && OPTIONAL_DETAILS="$OPTIONAL_DETAILS"$'\n\n'"### üîó Reference"$'\n\n'"- $REFERENCE"
          [ -n "$ADDITIONAL" ] && [ "$ADDITIONAL" != "_No response_" ] && OPTIONAL_DETAILS="$OPTIONAL_DETAILS"$'\n\n'"### ‚ûï Additional Information"$'\n\n'"$ADDITIONAL"

          NEW_BODY=$(cat <<EOF
          > **Type**: $TYPE
          > **Priority**: $PRIORITY
          $METADATA_SECTION

          ## ‚ùì Problem Statement

          $CONTEXT

          <br />

          ## üí° Proposed Solution

          $SOLUTION

          $OPTIONAL_DETAILS

          $CHECKLIST

          > ‚ö° Generated by **GitHub Actions**
          EOF
          )

          gh issue edit $ISSUE_NUMBER --body "$NEW_BODY"

  process-general:
    name: Process general issue
    needs: initialize-processing
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.issue.title, '[Bug]') && !contains(github.event.issue.labels.*.name, 'BugFix') && !contains(github.event.issue.title, '[Feature]') && !contains(github.event.issue.labels.*.name, 'Feature') }}
    env:
      TEMPLATE_PATH: .github/ISSUE_TEMPLATE/general.yml
    outputs:
      skipped: ${{ steps.validate.outputs.skipped }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Parse issue form
        uses: stefanbuck/github-issue-parser@v3
        id: issue-parser
        with:
          template-path: ${{ env.TEMPLATE_PATH }}

      - name: Validate parsed content
        id: validate
        env:
          SUMMARY: ${{ steps.issue-parser.outputs.issueparser_summary }}
          DESCRIPTION: ${{ steps.issue-parser.outputs.issueparser_description }}
        run: |
          if [ -z "$SUMMARY" ] || [ "$SUMMARY" = "_No response_" ] || [ -z "$DESCRIPTION" ] || [ "$DESCRIPTION" = "_No response_" ]; then
            echo "skipped=true" >> $GITHUB_OUTPUT
          else
            echo "skipped=false" >> $GITHUB_OUTPUT
          fi

      - name: Render checklist
        uses: ./.github/actions/render-checklist
        id: checklist
        if: steps.validate.outputs.skipped != 'true'
        with:
          template-path: ${{ env.TEMPLATE_PATH }}
          checklist-input: ${{ steps.issue-parser.outputs.issueparser_checklist }}

      - name: Update issue content
        if: steps.checklist.outcome == 'success'
        env:
          SUMMARY: ${{ steps.issue-parser.outputs.issueparser_summary }}
          DESCRIPTION: ${{ steps.issue-parser.outputs.issueparser_description }}
          EXPECTED: ${{ steps.issue-parser.outputs.issueparser_expected }}
          REFERENCE: ${{ steps.issue-parser.outputs.issueparser_reference }}
          ADDITIONAL: ${{ steps.issue-parser.outputs.issueparser_additional }}
          CHECKLIST: ${{ steps.checklist.outputs.section }}
        run: |
          OPTIONAL_DETAILS="<br />"
          [ -n "$EXPECTED" ] && [ "$EXPECTED" != "_No response_" ] && OPTIONAL_DETAILS="$OPTIONAL_DETAILS"$'\n\n'"### üéØ Expected Outcome"$'\n\n'"$EXPECTED"
          [ -n "$REFERENCE" ] && [ "$REFERENCE" != "_No response_" ] && OPTIONAL_DETAILS="$OPTIONAL_DETAILS"$'\n\n'"### üîó Reference"$'\n\n'"- $REFERENCE"
          [ -n "$ADDITIONAL" ] && [ "$ADDITIONAL" != "_No response_" ] && OPTIONAL_DETAILS="$OPTIONAL_DETAILS"$'\n\n'"### ‚ûï Additional Information"$'\n\n'"$ADDITIONAL"

          NEW_BODY=$(cat <<EOF
          ## üìå Summary

          $SUMMARY

          <br />

          ## üîç Description

          $DESCRIPTION

          $OPTIONAL_DETAILS

          $CHECKLIST

          > ‚ö° Generated by **GitHub Actions**
          EOF
          )

          gh issue edit $ISSUE_NUMBER --body "$NEW_BODY"

  finalize-processing:
    name: Finalize processing
    needs:
      [
        initialize-processing,
        process-bug-report,
        process-feature-request,
        process-general,
      ]
    runs-on: ubuntu-latest
    if: always()
    env:
      REPO: ${{ github.repository }}
      COMMENT_ID: ${{ needs.initialize-processing.outputs.comment-id }}
      CATEGORY: ${{ needs.initialize-processing.outputs.category }}
      GENERAL_SKIPPED: ${{ needs.process-general.outputs.skipped }}
      RESULT: ${{ ((needs.initialize-processing.outputs.category == 'bug-report' && needs.process-bug-report.result == 'success') || (needs.initialize-processing.outputs.category == 'feature-request' && needs.process-feature-request.result == 'success') || (needs.initialize-processing.outputs.category == 'general' && needs.process-general.result == 'success')) && 'success' || 'failure'  }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Add final comment
        run: |
          COMMENT_ICON="‚úÖ"
          COMMENT_STATUS="completed"
          COMMENT_DESCRIPTION="Labels have been synchronized and applied based on the issue content."

          if [ "$CATEGORY" = "general" ] && [ "$GENERAL_SKIPPED" = "true" ]; then
            COMMENT_ICON="‚è≠Ô∏è"
            COMMENT_STATUS="skipped"
            COMMENT_DESCRIPTION="This issue does not match any template (Bug Report / Feature Request / General)."
          elif [ "$RESULT" != "success" ]; then
            COMMENT_ICON="‚ùå"
            COMMENT_STATUS="failed"
            COMMENT_DESCRIPTION="There was an error while formatting the issue. Please check the issue content and labels for correctness."
          fi

          COMMENT_BODY="### $COMMENT_ICON Processing $COMMENT_STATUS!"$'\n\n'"$COMMENT_DESCRIPTION"

          gh api -X PATCH "repos/$REPO/issues/comments/$COMMENT_ID" \
            -f body="$COMMENT_BODY"
